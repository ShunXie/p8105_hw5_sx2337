p8105_hw5_sx2337
================
Shun Xie
2022-11-03

``` r
#load packages
library(tidyverse)
```

    ## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.2 ──
    ## ✔ ggplot2 3.3.6      ✔ purrr   0.3.4 
    ## ✔ tibble  3.1.8      ✔ dplyr   1.0.10
    ## ✔ tidyr   1.2.0      ✔ stringr 1.4.1 
    ## ✔ readr   2.1.2      ✔ forcats 0.5.2 
    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()

``` r
library(dbplyr)
```

    ## 
    ## 载入程辑包：'dbplyr'
    ## 
    ## The following objects are masked from 'package:dplyr':
    ## 
    ##     ident, sql

``` r
options(tibble.print_min = 5)
```

# Problem 1

``` r
All_files_names = list.files("data/")

All_files = 
  tibble(
    Name = str_remove(All_files_names, ".csv")) %>% 
  separate(Name, into = c("Control_Experiment","Index"), sep = "_") %>% 
  mutate(results =purrr::map(.x = str_c("data/",All_files_names), ~read_csv(.x, show_col_types = FALSE))) %>% 
  unnest(results) %>% 
  pivot_longer(
    cols = starts_with("week_"),
    names_to = "week_number",
    names_prefix = "week_",
    values_to = "value"
  ) %>% 
  ggplot(aes(x = week_number, y=value, group = Index))+
  geom_line(aes(color = Index)) + facet_grid(. ~ Control_Experiment)
All_files
```

![](p8105_hw5_sx2337_files/figure-gfm/unnamed-chunk-2-1.png)<!-- -->
Over the time, experiment group has a persistent increase over the week
while the control group has value relatively stable values below 5.0.

# Problem 2

``` r
homocide_data = read_csv("data-homicides-master/homicide-data.csv", show_col_types = FALSE)
homocide_data
```

    ## # A tibble: 52,179 × 12
    ##   uid    repor…¹ victi…² victi…³ victi…⁴ victi…⁵ victi…⁶ city  state   lat   lon
    ##   <chr>    <dbl> <chr>   <chr>   <chr>   <chr>   <chr>   <chr> <chr> <dbl> <dbl>
    ## 1 Alb-0…  2.01e7 GARCIA  JUAN    Hispan… 78      Male    Albu… NM     35.1 -107.
    ## 2 Alb-0…  2.01e7 MONTOYA CAMERON Hispan… 17      Male    Albu… NM     35.1 -107.
    ## 3 Alb-0…  2.01e7 SATTER… VIVIANA White   15      Female  Albu… NM     35.1 -107.
    ## 4 Alb-0…  2.01e7 MENDIO… CARLOS  Hispan… 32      Male    Albu… NM     35.1 -107.
    ## 5 Alb-0…  2.01e7 MULA    VIVIAN  White   72      Female  Albu… NM     35.1 -107.
    ## # … with 52,174 more rows, 1 more variable: disposition <chr>, and abbreviated
    ## #   variable names ¹​reported_date, ²​victim_last, ³​victim_first, ⁴​victim_race,
    ## #   ⁵​victim_age, ⁶​victim_sex

The data contains `12` number of columns corresponding to different
variables:

uid is a variable that uniquely identify the homocide case. Reported
date gives the data that the homocide case is reported. Victim
information such as the person’s last name, first name, race, age and
sex are also included in the variables. City and State variable
corresponds to the city and state that the homocide happens, as well as
the exact location measured in latitude and longitude in lat and lon
variables in the dataset. The disposition variable shows the current
state of the case. There are `3` unique status of disposition, namely
`Closed without arrest, Closed by arrest, Open/No arrest`.

Combine the city_state. Then summarize within cities to obtain the total
number of homicides and the number of unsolved homicides.

``` r
homocide_data_new = 
  homocide_data %>%
  mutate(city_state = str_c(city, ", ", state)) 

homocide_data_new%>% 
  group_by(city_state) %>% 
  summarize(
    n_obs = n(),
    n_unsolved = sum(disposition=='Closed without arrest')+sum(disposition=='Open/No arrest')
  ) %>% 
  arrange(desc(n_obs))
```

    ## # A tibble: 51 × 3
    ##   city_state       n_obs n_unsolved
    ##   <chr>            <int>      <int>
    ## 1 Chicago, IL       5535       4073
    ## 2 Philadelphia, PA  3037       1360
    ## 3 Houston, TX       2942       1493
    ## 4 Baltimore, MD     2827       1825
    ## 5 Detroit, MI       2519       1482
    ## # … with 46 more rows

For the city of Baltimore, MD, the proportion of homicides that is
unsolved can be calculated here:

``` r
homocide_data_new_Baltimore = filter(homocide_data_new, city_state == "Baltimore, MD")  

#save as an R object 
prop_Baltimore_result = prop.test(sum(homocide_data_new_Baltimore$disposition=='Closed without arrest' | homocide_data_new_Baltimore$disposition=='Open/No arrest'),length(homocide_data_new_Baltimore$disposition))

#save the data
save(prop_Baltimore_result, file = "results/Prop_result_Baltimore.RData")


#apply tidy function and pull the estimate and confidence intervals
prop_Baltimore_result %>% 
  broom::tidy() %>% 
  select(estimate, conf.low, conf.high)
```

    ## # A tibble: 1 × 3
    ##   estimate conf.low conf.high
    ##      <dbl>    <dbl>     <dbl>
    ## 1    0.646    0.628     0.663

For all cities, first get all the distinct cities vector, and create a
function that do the exact the same thing with city Baltimore:

``` r
all_distinct_city = unique(homocide_data_new$city_state)

prop_test_function = function(cityname){
  dataset = filter(homocide_data_new, city_state == cityname)
  result = 
    prop.test(sum(dataset$disposition=='Closed without arrest' | dataset$disposition=='Open/No arrest'), length(dataset$disposition)) %>% 
    broom::tidy() %>% 
    select(estimate, conf.low, conf.high)
  
  #return result
  result
}
```

Now can iterate over all distinct cities using apply function and store
in a list:

``` r
#create list to store all variables
prop_test_output = 
  expand_grid(
    city_name = all_distinct_city
  ) %>% 
  mutate(
    test_df = map(all_distinct_city, prop_test_function)
  ) %>% 
  unnest(test_df) %>% 
  arrange(desc(estimate))
```

    ## Warning in prop.test(sum(dataset$disposition == "Closed without arrest" | : Chi-
    ## squared近似算法有可能不准

``` r
prop_test_output
```

    ## # A tibble: 51 × 4
    ##   city_name          estimate conf.low conf.high
    ##   <chr>                 <dbl>    <dbl>     <dbl>
    ## 1 Chicago, IL           0.736    0.724     0.747
    ## 2 New Orleans, LA       0.649    0.623     0.673
    ## 3 Baltimore, MD         0.646    0.628     0.663
    ## 4 San Bernardino, CA    0.618    0.558     0.675
    ## 5 Buffalo, NY           0.612    0.569     0.654
    ## # … with 46 more rows

``` r
ggplot(prop_test_output, aes(x=fct_reorder(city_name, estimate), y=estimate))+
  geom_point()+
  coord_flip()+
  geom_errorbar(aes(ymin=conf.low, ymax=conf.high))+
  labs(title = "Proportion of unsolved homocide among cities", )+xlab("City")
```

![](p8105_hw5_sx2337_files/figure-gfm/unnamed-chunk-8-1.png)<!-- -->
